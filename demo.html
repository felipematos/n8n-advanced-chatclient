<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <script>
      
        // Language content map
        var languageContent = {
            en: {
                welcomeText: 'Hi üëã, how can we help?',
                responseTimeText: 'We typically respond right away'
            },
            pt: {
                welcomeText: 'Ol√° üëã, como podemos ajudar?',
                responseTimeText: 'Geralmente respondemos imediatamente'
            },
            es: {
                welcomeText: 'Hola üëã, ¬øc√≥mo podemos ayudar?',
                responseTimeText: 'Solemos responder de imediato'
            },
            ar: {
                welcomeText: 'ŸÖÿ±ÿ≠ÿ®Ÿãÿß üëãÿå ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜÿß ÿßŸÑŸÖÿ≥ÿßÿπÿØÿ©ÿü',
                responseTimeText: 'ÿπÿßÿØÿ©Ÿã ŸÖÿß ŸÜÿ±ÿØ ÿπŸÑŸâ ÿßŸÑŸÅŸàÿ±'
            }
        };
    
        // Detect language from URL
        var url = window.location.href;
        var langMatch = url.match(/\/(en|pt|es|ar)(\/|$)/);
        var lang;
        
        if (langMatch) {
            // Language from URL
            lang = langMatch[1];
        } else {
            // Try to detect browser language
            var browserLang = (navigator.language || navigator.userLanguage || '').split('-')[0];
            // Fallback to English if browser language is not supported
            lang = languageContent[browserLang] ? browserLang : 'en';
        }
        
        // Ensure we have valid content for the selected language
        var content = languageContent[lang] || languageContent['en'];
    
        // Function to detect user location
        function detectUserLocation() {
            return new Promise(function(resolve, reject) {
                // Try using the IP Geolocation API
                fetch('https://ipapi.co/json/')
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data && data.city) {
                            var location = data.city;
                            if (data.region) location += ', ' + data.region;
                            if (data.country_name) location += ', ' + data.country_name;
                            resolve(location);
                        } else {
                            reject('Location not available');
                        }
                    })
                    .catch(function(error) {
                        // Fallback to another IP service if the first one fails
                        fetch('https://ipinfo.io/json')
                            .then(function(response) { return response.json(); })
                            .then(function(data) {
                                if (data && data.city) {
                                    var location = data.city;
                                    if (data.region) location += ', ' + data.region;
                                    if (data.country) location += ', ' + data.country;
                                    resolve(location);
                                } else {
                                    reject('Location not available');
                                }
                            })
                            .catch(function(err) {
                                reject('Location detection failed');
                            });
                    });
            });
        }
        
        // Initialize metadata object
        var chatMetadata = {
            userLanguage: lang,
            chatGreeting: content.welcomeText,
            baseUrl: window.location.origin,
            detectedLocation: '',
            userEmail: ''
        };
        
        // Try to get user location
        detectUserLocation()
            .then(function(location) {
                chatMetadata.detectedLocation = location;
                if (window.ChatWidgetConfig && window.ChatWidgetConfig.debug) {
                    console.log('Location detected:', location);
                }
            })
            .catch(function(error) {
                if (window.ChatWidgetConfig && window.ChatWidgetConfig.debug) {
                    console.log('Location detection failed:', error);
                }
            });
            
        // Try to get user email from localStorage or cookies if available
        try {
            var savedEmail = localStorage.getItem('userEmail') || getCookie('userEmail');
            if (savedEmail) {
                chatMetadata.userEmail = savedEmail;
            }
        } catch (e) {
            // Ignore any errors when accessing storage
        }
        
        // Helper function to get cookies
        function getCookie(name) {
            var value = '; ' + document.cookie;
            var parts = value.split('; ' + name + '=');
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
    
        // Chat widget configuration
        window.ChatWidgetConfig = {
            webhook: {
                url: 'https://n8n.10k.digital/webhook/f406671e-c954-4691-b39a-66c90aa2f103/chat',
                route: 'general'
            },
            branding: {
                logo: 'https://10k.digital/wp-content/uploads/2025/03/cropped-favicon-10k-32x32.png',
                name: '10K.Digital',
                welcomeText: content.welcomeText,
                responseTimeText: content.responseTimeText,
                poweredBy: {
                    text: '',
                    link: ''
                }
            },
            style: {
                primaryColor: '#080A56',
                secondaryColor: '#0b0f7b',
                position: 'right',
                backgroundColor: '#ffffff',
                fontColor: '#333333'
            },
            // Definir como true para habilitar logs de depura√ß√£o
            debug: true,
            onError: function(error) {
                // Suprimir erros em produ√ß√£o
                if (window.ChatWidgetConfig.debug) {
                    console.error('Widget error:', error.message);
                }
            },
            // Custom metadata to be sent with each message
            metadata: chatMetadata
        };
    
        // Determine the script source based on protocol
        var scriptSrc;
        if (window.location.protocol === 'file:') {
            // Local file
            scriptSrc = './chat-widget.js';
        } else {
            // Web file (http or https)
            scriptSrc = 'https://felipematos.github.io/n8n-advanced-chatclient/chat-widget.js';
        }
        
        // Override fetch to inject metadata into webhook requests
        var originalFetch = window.fetch;
        window.fetch = function(url, options) {
            // Only modify webhook requests to n8n
            if (url && typeof url === 'string' && url.includes('n8n.10k.digital/webhook')) {
                if (window.ChatWidgetConfig && window.ChatWidgetConfig.debug) {
                    console.log('Intercepted webhook request:', url);
                }
                
                try {
                    // Initialize options if not provided
                    options = options || {};
                    options.headers = options.headers || {};
                    
                    // Parse the body if it exists
                    if (options.body && typeof options.body === 'string') {
                        var body = JSON.parse(options.body);
                        
                        // Add metadata to the request
                        body.metadata = JSON.stringify({
                            userLanguage: chatMetadata.userLanguage,
                            baseUrl: chatMetadata.baseUrl,
                            detectedLocation: chatMetadata.detectedLocation,
                            chatGreeting: chatMetadata.chatGreeting,
                            userEmail: chatMetadata.userEmail
                        });
                        
                        // Update the request body
                        options.body = JSON.stringify(body);
                        
                        if (window.ChatWidgetConfig && window.ChatWidgetConfig.debug) {
                            console.log('Updated request body with metadata:', options.body);
                        }
                    }
                } catch (e) {
                    if (window.ChatWidgetConfig && window.ChatWidgetConfig.debug) {
                        console.error('Error intercepting fetch request:', e);
                    }
                }
            }
            
            // Call the original fetch with possibly modified options
            return originalFetch.call(this, url, options);
        };
        
        // Dynamically load the chat widget script with error handling
        var script = document.createElement('script');
        script.src = scriptSrc;
        script.async = true;
        script.onload = function() {
            if (window.ChatWidgetConfig.debug) {
                console.log('Chat widget script loaded successfully');
            }
            
            // Define a global variable to store the chat component instance
            var chatComponentInterval = setInterval(function() {
                // Check if the chat component has been loaded
                if (window.N8nChat) {
                    clearInterval(chatComponentInterval);
                    
                    if (window.ChatWidgetConfig.debug) {
                        console.log('Chat component found. Setting up metadata interceptor.');
                    }
                    
                    // Override the original sendMessage method to include our metadata
                    var originalSendMessage = window.N8nChat.sendMessage;
                    window.N8nChat.sendMessage = function(data) {
                        // Add our metadata to the existing data
                        if (!data.metadata) {
                            data.metadata = {};
                        } else if (typeof data.metadata === 'string') {
                            try {
                                data.metadata = JSON.parse(data.metadata);
                            } catch (e) {
                                data.metadata = {};
                            }
                        }
                        
                        // Ensure our key metadata fields are included
                        data.metadata.userLanguage = chatMetadata.userLanguage;
                        data.metadata.baseUrl = chatMetadata.baseUrl;
                        data.metadata.detectedLocation = chatMetadata.detectedLocation;
                        
                        // Add other metadata if available
                        if (chatMetadata.chatGreeting) {
                            data.metadata.chatGreeting = chatMetadata.chatGreeting;
                        }
                        if (chatMetadata.userEmail) {
                            data.metadata.userEmail = chatMetadata.userEmail;
                        }
                        
                        // Convert back to string if needed
                        data.metadata = JSON.stringify(data.metadata);
                        
                        if (window.ChatWidgetConfig.debug) {
                            console.log('Sending message with metadata:', data);
                        }
                        
                        // Call the original method with our enhanced data
                        return originalSendMessage.call(this, data);
                    };
                    
                    // Also ensure webhook configuration includes metadata
                    if (window.N8nChat.webhook && typeof window.N8nChat.webhook.configure === 'function') {
                        var originalConfigure = window.N8nChat.webhook.configure;
                        window.N8nChat.webhook.configure = function(config) {
                            if (!config.metadata) {
                                config.metadata = chatMetadata;
                            }
                            return originalConfigure.call(this, config);
                        };
                        
                        // Reconfigure with our metadata if already configured
                        if (window.N8nChat.webhook.config) {
                            window.N8nChat.webhook.config.metadata = chatMetadata;
                        }
                    }
                }
            }, 100); // Check every 100ms
        };
        script.onerror = function() {
            console.error('Error loading chat widget script');
        };
        document.body.appendChild(script);
    
        // Ensure target element exists
        var targetDiv = document.createElement('div');
        targetDiv.id = 'n8n-chat';
        document.body.appendChild(targetDiv);
    </script>
</body>
</html> 